<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.eats.mapper.store.ReserveMapper">
	<select id="tables" parameterType="map" resultType="com.eats.store.model.reserve.TableDTO">
		select 
			table_num, 
			sts_num as cnt, 
			NVL(reserve_state, -1) as stat, 
			cv.cate_value_name as tabletype
		from 
			store_table_set sts 
		left join 
			reservation r 
		on 
			r.reserve_table_idx = sts.sts_idx 
			and store_idx = #{storeIdx}
			and reserve_date = TO_DATE(#{day}, 'YYYY-MM-DD') 
			and reserve_time = #{time} 
		left join 
			cate_value cv 
		on 
			sts.sts_type_idx = cv.cate_value_idx
		order by 
			table_num asc
	</select>
	<select id = "reserveList" parameterType="map" resultType="com.eats.store.model.reserve.ReserveListDTO">
		SELECT 
			r.reserve_idx,
			r.reserve_date,
			r.reserve_time,
			r.reserve_count,
			r.reserve_table_idx,
			r.request,
			r.reserve_state,
			r.reserve_applydate,
			u.user_name,
			up.user_tel,
			up.user_nickname
		FROM 
			reservation r
		JOIN eats_user u 
			ON r.user_idx = u.user_idx
		JOIN user_profile up 
			ON u.user_idx = up.user_idx
		WHERE 
			r.store_idx = #{storeIdx}
			AND r.reserve_date = TO_DATE(#{day}, 'YYYY-MM-DD')
			AND r.reserve_time = #{time}
	</select>

	<select id="storeTime" parameterType="map" resultType="com.eats.store.model.reserve.StoreTimeDTO">
		SELECT 
			stime_start,
			stime_end,
			stime_break
		FROM 
			store_time
		WHERE 
			store_idx = #{storeIdx}
			AND stime_day = #{stimeDay}
	</select>
	<update id="assignTable" parameterType="map">
		UPDATE RESERVATION r
		SET 
			RESERVE_STATE = 1,
			RESERVE_TABLE_IDX = (
				SELECT sts.STS_IDX
				FROM STORE_TABLE_SET sts
				WHERE sts.TABLE_NUM = #{tableNum}
				AND sts.STS_IDX IN (
					SELECT sts2.STS_IDX 
					FROM STORE_TABLE_SET sts2
					INNER JOIN STORE_GRID sg ON sts2.SG_IDX = sg.SG_IDX
					WHERE sg.STORE_IDX = #{storeIdx}
				)
				AND ROWNUM = 1
			)
		WHERE r.RESERVE_IDX = #{reserveIdx}
	</update>
</mapper>